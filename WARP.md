# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Overview

This is an AdonisJS 5 TypeScript API that integrates with Bunny.net Stream for video management. The API provides endpoints to upload videos from URLs, manage video metadata, and perform CRUD operations on videos stored in Bunny.net's streaming platform.

## Development Commands

### Core Development
```bash
# Start development server with hot reload
npm run dev

# Run tests
npm test

# Build for production
npm run build

# Start production server
npm start
```

### AdonisJS Ace Commands
```bash
# Run specific ace command
node ace <command>

# List all available ace commands
node ace list

# Run tests with specific configuration
node ace test
```

### Single Test Execution
```bash
# Run a specific test file
node ace test tests/functional/hello_world.spec.ts
```

## Architecture & Code Structure

### AdonisJS MVC Pattern
The project follows AdonisJS 5 conventions with TypeScript:

- **Controllers** (`app/Controllers/Http/`): Handle HTTP requests and responses
- **Services** (`app/Services/`): Business logic and external API integrations  
- **Validators** (`app/Validators/`): Request validation schemas
- **Routes** (`start/routes.ts`): API endpoint definitions
- **Config** (`config/`): Application configuration files
- **Contracts** (`contracts/`): TypeScript type definitions and interfaces

### Key Components

#### VideosController
- Main API controller handling all video-related endpoints
- Methods: `uploadFromUrl`, `index`, `show`, `update`, `destroy`
- Uses dependency injection pattern with BunnyStreamService
- Implements comprehensive error handling with consistent response format

#### BunnyStreamService  
- Core service class for Bunny.net Stream API integration
- Handles authentication via AccessKey headers
- Methods: `createVideo`, `uploadVideoFromUrl`, `getVideo`, `deleteVideo`, `listVideos`, `updateVideo`
- Uses axios for HTTP requests with proper error handling
- Implements TypeScript interfaces for API responses

#### Validation Layer
- **VideoUploadValidator**: Validates video upload requests (URL, title, optional collectionId)
- **VideoUpdateValidator**: Validates video update requests with optional fields
- Uses AdonisJS schema validation with custom error messages
- Supports complex validation for chapters, moments, and metaTags arrays

### API Design Patterns

#### RESTful API Structure
- Base URL: `/api/v1`
- Follows standard HTTP verbs (GET, POST, PUT, DELETE)
- Consistent response format with `message` and `data` fields
- Proper HTTP status codes (200, 400, 404, 500)

#### Error Handling Strategy
- Service layer throws descriptive errors
- Controller catches and transforms to HTTP responses  
- Validation errors automatically handled by AdonisJS validators
- External API errors (Bunny.net) wrapped with context

### Environment Configuration

Required environment variables for Bunny.net integration:
- `BUNNY_STREAM_API_KEY`: Authentication key for Bunny.net API
- `BUNNY_STREAM_LIBRARY_ID`: Target library ID for video storage
- `BUNNY_STREAM_BASE_URL`: Base URL for Bunny.net API (defaults to https://video.bunnycdn.com)

### Test Infrastructure
- Uses Japa test runner with AdonisJS preset
- Functional tests located in `tests/functional/`
- Test configuration in `.adonisrc.json` with 60-second timeout
- Bootstrap file at `tests/bootstrap.ts` for test setup

### TypeScript Configuration
- Strict TypeScript configuration via `tsconfig.json`
- AdonisJS path aliases configured: `App`, `Config`, `Database`, `Contracts`
- IoC container pattern for dependency injection
- Strong typing for Bunny.net API responses and request payloads

## Important Implementation Details

### Bunny.net Integration Specifics
- Videos have status codes: 0 (Created), 1 (Uploaded), 2 (Failed), 3 (Encoding), 4 (Finished), 5 (Resolution finished)
- Upload from URL is asynchronous - returns task ID for tracking
- Video IDs are GUIDs generated by Bunny.net
- Supports pagination, search, and ordering for video listing

### Request/Response Patterns
- All endpoints return structured JSON with `message` and optional `data` fields
- Validation errors include field-specific error messages
- Video metadata supports complex structures (chapters, moments, metaTags)
- Consistent error handling across all endpoints

### Security Considerations
- API key stored in environment variables
- Input validation on all endpoints
- URL validation for video uploads (HTTP/HTTPS only)
- Length limits on text fields to prevent abuse
